<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <title>Uƒçitelsk√Ω Editor - Dƒõjepis SRS v1.5+ (Vylep≈°en√Ω)</title>
    <style>
        :root { --primary: #1a3a5a; --accent: #e67e22; --bg: #f4f7f6; --text: #2c3e50; --danger: #e74c3c; }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg); color: var(--text); margin: 0; height: 100vh; display: flex; flex-direction: column; }
        
        /* HEADER */
        header { background: white; padding: 15px 30px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #ddd; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        h1 { margin: 0; font-size: 1.2rem; color: var(--primary); display: flex; align-items: center; gap: 10px; }
        
        .top-btn-group { display: flex; gap: 10px; }
        button { cursor: pointer; padding: 8px 15px; border-radius: 6px; border: none; font-weight: bold; transition: 0.2s; }
        .btn-main { background: var(--primary); color: white; } .btn-main:hover { background: #132c45; }
        .btn-sec { background: white; border: 1px solid #ccc; color: #555; } .btn-sec:hover { background: #f0f0f0; }
        .btn-danger { background: #fff; border: 1px solid var(--danger); color: var(--danger); } .btn-danger:hover { background: var(--danger); color: white; }
        .btn-ai { background: #e6f4ea; border: 1px solid #ceead6; color: #1e8e3e; } .btn-ai:hover { background: #dceid5; }
        .btn-qr { background: #fff8e1; border: 1px solid #ffe082; color: #f57f17; } .btn-qr:hover { background: #ffecb3; }
        
        .workspace { display: flex; flex: 1; overflow: hidden; }
        .sidebar { width: 250px; background: white; border-right: 1px solid #ddd; display: flex; flex-direction: column; }
        .deck-list { flex: 1; overflow-y: auto; padding: 10px; }
        .deck-item { padding: 12px; margin-bottom: 5px; cursor: pointer; border-radius: 6px; display: flex; justify-content: space-between; }
        .deck-item:hover { background: #f0f5f9; } .deck-item.active { background: var(--primary); color: white; }
        
        .main-area { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; }
        .deck-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; background: white; padding: 15px; border-radius: 8px; border: 1px solid #ddd; }
        
        /* TABLE */
        table { width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.02); }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #eee; vertical-align: middle; }
        th { background: #f8f9fa; font-weight: 600; color: #666; font-size: 0.9rem; }
        .col-img { width: 50px; text-align: center; }
        .thumb { width: 40px; height: 40px; object-fit: cover; border-radius: 4px; border: 1px solid #eee; background: #eee; cursor: zoom-in; }
        .action-btn { background: none; border: none; font-size: 1.1rem; padding: 5px; opacity: 0.6; cursor: pointer; transition: 0.2s; }
        .action-btn:hover { opacity: 1; transform: scale(1.2); }

        /* MODAL */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; display: none; justify-content: center; align-items: center; }
        .modal { background: white; width: 600px; max-width: 90%; max-height: 90vh; border-radius: 12px; display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .modal-header { padding: 15px 20px; background: #f8f9fa; border-bottom: 1px solid #eee; font-weight: bold; display: flex; justify-content: space-between; }
        .modal-body { padding: 20px; overflow-y: auto; }
        .modal-footer { padding: 15px 20px; border-top: 1px solid #eee; text-align: right; background: #f8f9fa; }
        
        .form-group { margin-bottom: 15px; }
        label { display: block; font-size: 0.85rem; font-weight: bold; margin-bottom: 5px; color: #555; }
        input[type="text"], textarea { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px; font-family: inherit; box-sizing: border-box; }
        textarea { min-height: 80px; resize: vertical; }
        
        .img-drop-zone { border: 2px dashed #ccc; padding: 10px; text-align: center; border-radius: 6px; margin-top: 5px; background: #fafafa; display: flex; align-items: center; justify-content: center; gap: 10px; min-height: 50px; }
        .preview-large { max-height: 80px; max-width: 100%; display: block; }
        .hidden { display: none; }

        .link-box { background: #e3f2fd; padding: 10px; border: 1px solid #90caf9; color: #1565c0; font-family: monospace; word-break: break-all; margin-top:10px; cursor: pointer; }
        .ai-box { background: #f4f7f6; padding: 15px; border-radius: 8px; border: 1px solid #ddd; font-family: monospace; font-size: 0.85rem; white-space: pre-wrap; margin-bottom: 15px; color: #333; }
        
        /* Lightbox */
        .lightbox-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 2000; display: none; justify-content: center; align-items: center; cursor: zoom-out; }
        .lightbox-img { max-width: 90%; max-height: 90%; border-radius: 4px; box-shadow: 0 0 20px rgba(0,0,0,0.5); }
    </style>
</head>
<body>

<header>
    <h1>üéì Uƒçitelsk√Ω Editor <span style="font-size:0.8rem; opacity:0.6; font-weight:normal;">v1.5+</span></h1>
    <div class="top-btn-group">
        <button class="btn-qr" onclick="openQrModal()" title="Vytvo≈ôit odkaz pro ≈æ√°ky">üîó Generovat odkaz</button>
        <button class="btn-ai" onclick="openAiModal()" title="Generovat ot√°zky pomoc√≠ AI">ü§ñ AI Prompt</button>
        <button class="btn-sec" onclick="document.getElementById('file-in').click()" title="Nahr√°t soubor z poƒç√≠taƒçe">üìÇ Nahr√°t JSON</button>
        <button class="btn-main" onclick="exportData()" title="St√°hnout soubor pro ≈æ√°ky">üíæ Ulo≈æit JSON</button>
    </div>
    <input type="file" id="file-in" accept=".json" style="display:none" onchange="importData(event)" onclick="this.value=null">
</header>

<div class="workspace">
    <div class="sidebar">
        <div class="deck-list" id="deck-list"></div>
        <div style="padding:15px; border-top:1px solid #eee;">
            <button class="btn-main" style="width:100%" onclick="addNewDeck()">‚ûï Nov√© t√©ma</button>
            <button class="btn-danger" style="width:100%; margin-top:10px;" onclick="wipeAllData()">üóëÔ∏è Reset</button>
        </div>
    </div>

    <div class="main-area" id="main-area">
        <div style="text-align:center; color:#999; margin-top:50px;">Vyberte t√©ma vlevo nebo vytvo≈ôte nov√©.</div>
    </div>
</div>

<div class="modal-overlay" id="modal-overlay">
    <div class="modal">
        <div class="modal-header"><span>Editace karty</span><button onclick="closeModal('modal-overlay')" style="border:none; background:none; font-size:1.2rem; cursor:pointer;">‚úñ</button></div>
        <div class="modal-body">
            <input type="hidden" id="edit-id">
            
            <div class="form-group">
                <label>Ot√°zka</label>
                <input type="text" id="edit-q" placeholder="Znƒõn√≠ ot√°zky...">
                <div class="img-drop-zone">
                    <label class="btn-sec" style="font-size:0.8rem; padding:5px 10px;">üì∑ Nahr√°t<input type="file" hidden accept="image/*" onchange="processFile(this.files[0], 'q')"></label>
                    <img id="prev-q" class="preview-large hidden">
                    <button class="btn-danger hidden" id="del-q" onclick="removeImg('q')" style="padding:2px 8px; font-size:0.7rem;">X</button>
                </div>
            </div>

            <div class="form-group">
                <label>Odpovƒõƒè (ka≈æd√Ω ≈ô√°dek = jedna odr√°≈æka)</label>
                <textarea id="edit-a" placeholder="Odpovƒõƒè..."></textarea>
                <div class="img-drop-zone">
                    <label class="btn-sec" style="font-size:0.8rem; padding:5px 10px;">üì∑ Nahr√°t<input type="file" hidden accept="image/*" onchange="processFile(this.files[0], 'a')"></label>
                    <img id="prev-a" class="preview-large hidden">
                    <button class="btn-danger hidden" id="del-a" onclick="removeImg('a')" style="padding:2px 8px; font-size:0.7rem;">X</button>
                </div>
            </div>
            
            <div class="form-group">
                <label style="display:flex; align-items:center; cursor:pointer;">
                    <input type="checkbox" id="edit-expert" style="width:20px; height:20px; margin-right:10px;">
                    üéì Roz≈°i≈ôuj√≠c√≠ uƒçivo (Expert)
                </label>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn-sec" onclick="closeModal('modal-overlay')">Zru≈°it</button>
            <button class="btn-main" onclick="saveCard()">Ulo≈æit kartu</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="qr-modal">
    <div class="modal" style="width:500px;">
        <div class="modal-header"><span>üîó Gener√°tor odkazu</span><button onclick="closeModal('qr-modal')" style="border:none; background:none;">‚úñ</button></div>
        <div class="modal-body">
            <p>Zadejte p≈ôesn√Ω n√°zev souboru na GitHubu (nap≈ô. velka_morava.json):</p>
            <input type="text" id="qr-filename" style="width:100%">
            <div id="qr-result" class="hidden" style="margin-top:20px; text-align:center;">
                <label>Odkaz pro ≈æ√°ky:</label>
                <div class="link-box" id="qr-link-text" onclick="copyLink()"></div>
                <div style="margin-top:15px;"><img id="qr-image" style="max-width:200px; border:1px solid #ccc;"></div>
            </div>
        </div>
        <div class="modal-footer"><button class="btn-main" onclick="generateQr()">Generovat</button></div>
    </div>
</div>

<div class="modal-overlay" id="ai-modal">
    <div class="modal">
        <div class="modal-header"><span>ü§ñ AI Prompt</span><button onclick="closeModal('ai-modal')" style="border:none; background:none;">‚úñ</button></div>
        <div class="modal-body">
            <div class="ai-box" id="ai-prompt-text">Vytvo≈ô mi sadu 10 ot√°zek na t√©ma [T√âMA].
V√Ωstup mus√≠ b√Ωt ƒçist√Ω JSON v tomto form√°tu:
{
  "N√°zev T√©matu": [
    {
      "q": "Ot√°zka?",
      "a": ["Odpovƒõƒè 1"],
      "expert": false
    }
  ]
}</div>
        </div>
        <div class="modal-footer"><button class="btn-main" onclick="copyAiPrompt()">Kop√≠rovat</button></div>
    </div>
</div>

<div class="lightbox-overlay" id="lightbox" onclick="this.style.display='none'">
    <img id="lightbox-img" class="lightbox-img">
</div>

<script>
    let decks = JSON.parse(localStorage.getItem("teacher_decks_v1")) || {};
    let currentDeck = null;
    let editingCardId = null;
    let tempImgQ = "";
    let tempImgA = "";

    function renderDeckList() {
        const list = document.getElementById('deck-list');
        list.innerHTML = "";
        Object.keys(decks).forEach(name => {
            const div = document.createElement('div');
            div.className = `deck-item ${currentDeck === name ? 'active' : ''}`;
            div.innerHTML = `<span>${name}</span> <span style="opacity:0.7; font-size:0.8rem;">(${decks[name].length})</span>`;
            div.onclick = () => { currentDeck = name; renderDeckList(); renderMainArea(); };
            list.appendChild(div);
        });
    }

    function addNewDeck() {
        const name = prompt("N√°zev nov√©ho t√©matu:");
        if (name && !decks[name]) { decks[name] = []; currentDeck = name; renderDeckList(); renderMainArea(); saveState(); }
    }

    function renderMainArea() {
        if (!currentDeck) return;
        const area = document.getElementById('main-area');
        
        let html = `
            <div class="deck-header">
                <h2 style="margin:0;">${currentDeck}</h2>
                <div>
                    <button class="btn-main" onclick="openModal()">‚ûï P≈ôidat</button>
                    <button class="btn-danger" onclick="deleteDeck()">üóëÔ∏è Smazat t√©ma</button>
                </div>
            </div>
            <table><thead><tr>
                <th class="col-img">Obr</th>
                <th>Ot√°zka</th>
                <th>Odpovƒõƒè</th>
                <th class="col-img">Obr</th>
                <th style="width:160px; text-align:right;">Akce</th>
            </tr></thead><tbody>
        `;
        
        decks[currentDeck].forEach((card, index) => {
            const qThumb = card.qImg ? `<img src="${card.qImg}" class="thumb" onclick="showLightbox('${card.qImg}')">` : '-';
            const aThumb = card.aImg ? `<img src="${card.aImg}" class="thumb" onclick="showLightbox('${card.aImg}')">` : '-';
            const expertMark = card.expert ? 'üéì ' : '';

            html += `<tr>
                <td class="col-img">${qThumb}</td>
                <td>${expertMark}${card.q}</td>
                <td>${Array.isArray(card.a) ? card.a.join(', ') : card.a}</td>
                <td class="col-img">${aThumb}</td>
                <td style="text-align:right;">
                    <button class="action-btn" onclick="moveCard(${index}, -1)" title="Nahoru">‚¨ÜÔ∏è</button>
                    <button class="action-btn" onclick="moveCard(${index}, 1)" title="Dol≈Ø">‚¨áÔ∏è</button>
                    <button class="action-btn" onclick="duplicateCard(${index})" title="Duplikovat">üìã</button>
                    <button class="action-btn" onclick="openModal(${index})" title="Upravit">‚úèÔ∏è</button>
                    <button class="action-btn" style="color:red;" onclick="removeCard(${index})" title="Smazat">üóëÔ∏è</button>
                </td>
            </tr>`;
        });
        html += `</tbody></table>`;
        area.innerHTML = html;
    }

    // --- MANIPULACE S KARTAMI ---
    function deleteDeck() {
        if(confirm(`Opravdu smazat t√©ma "${currentDeck}"?`)) {
            delete decks[currentDeck];
            currentDeck = null;
            renderDeckList();
            document.getElementById('main-area').innerHTML = '<div style="text-align:center; color:#999; margin-top:50px;">Vyberte t√©ma vlevo.</div>';
            saveState();
        }
    }

    function removeCard(index) {
        if(confirm("Smazat kartu?")) {
            decks[currentDeck].splice(index, 1);
            renderMainArea(); renderDeckList(); saveState();
        }
    }

    function moveCard(index, direction) {
        const newIndex = index + direction;
        if (newIndex >= 0 && newIndex < decks[currentDeck].length) {
            const arr = decks[currentDeck];
            [arr[index], arr[newIndex]] = [arr[newIndex], arr[index]];
            renderMainArea(); saveState();
        }
    }

    function duplicateCard(index) {
        const card = decks[currentDeck][index];
        const newCard = JSON.parse(JSON.stringify(card)); // Deep copy
        newCard.id = Date.now(); // Nov√© ID
        decks[currentDeck].splice(index + 1, 0, newCard);
        renderMainArea(); renderDeckList(); saveState();
    }

    // --- MODAL & OBR√ÅZKY ---
    function openModal(index = null) {
        document.getElementById('modal-overlay').style.display = 'flex';
        tempImgQ = ""; tempImgA = "";
        
        if (index !== null) {
            editingCardId = index;
            const c = decks[currentDeck][index];
            document.getElementById('edit-q').value = c.q;
            document.getElementById('edit-a').value = Array.isArray(c.a) ? c.a.join('\n') : c.a;
            document.getElementById('edit-expert').checked = c.expert || false;
            tempImgQ = c.qImg || "";
            tempImgA = c.aImg || "";
        } else {
            editingCardId = null;
            document.getElementById('edit-q').value = "";
            document.getElementById('edit-a').value = "";
            document.getElementById('edit-expert').checked = false;
        }
        updatePreview('q'); updatePreview('a');
    }

    function closeModal(id) { document.getElementById(id).style.display = 'none'; }

    function saveCard() {
        const q = document.getElementById('edit-q').value.trim();
        const aVal = document.getElementById('edit-a').value.trim();
        const isExpert = document.getElementById('edit-expert').checked;

        if (!q || !aVal) { alert("Vypl≈àte ot√°zku a odpovƒõƒè."); return; }

        const newCard = {
            id: Date.now(), // Generujeme ID i tady
            q: q,
            a: aVal.split('\n'),
            qImg: tempImgQ,
            aImg: tempImgA,
            expert: isExpert,
            // SRS v√Ωchoz√≠ hodnoty
            reps: 0, interval: 0, ef: 2.5, nextReview: Date.now()
        };

        if (editingCardId !== null) {
            // Zachovat star√° SRS data a ID p≈ôi editaci
            const old = decks[currentDeck][editingCardId];
            newCard.id = old.id || Date.now();
            newCard.reps = old.reps || 0;
            newCard.interval = old.interval || 0;
            newCard.ef = old.ef || 2.5;
            newCard.nextReview = old.nextReview || Date.now();
            decks[currentDeck][editingCardId] = newCard;
        } else {
            decks[currentDeck].push(newCard);
        }

        closeModal('modal-overlay');
        renderMainArea(); renderDeckList(); saveState();
    }

    function processFile(file, type) {
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            if (type === 'q') tempImgQ = e.target.result;
            else tempImgA = e.target.result;
            updatePreview(type);
        };
        reader.readAsDataURL(file);
    }

    function updatePreview(type) {
        const url = (type === 'q') ? tempImgQ : tempImgA;
        const img = document.getElementById(`prev-${type}`);
        const del = document.getElementById(`del-${type}`);
        if (url) {
            img.src = url; img.classList.remove('hidden'); del.classList.remove('hidden');
        } else {
            img.classList.add('hidden'); del.classList.add('hidden');
        }
    }

    function removeImg(type) {
        if (type === 'q') tempImgQ = ""; else tempImgA = "";
        updatePreview(type);
    }

    // --- IMPORT / EXPORT ---
    function saveState() { localStorage.setItem("teacher_decks_v1", JSON.stringify(decks)); }
    
    function exportData() {
        const dataStr = JSON.stringify(decks, null, 2);
        const blob = new Blob([dataStr], {type: "application/json"});
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = "historie_srs.json"; a.click();
    }
    
    function importData(e) {
        const file = e.target.files[0]; if (!file) return;
        const reader = new FileReader();
        reader.onload = (v) => {
            try {
                let txt = v.target.result;
                // FIX PRO EDGE (BOM)
                if (txt.charCodeAt(0) === 0xFEFF) txt = txt.slice(1);
                
                const data = JSON.parse(txt);
                // Slouƒçen√≠ dat
                decks = Object.assign(decks, data);
                saveState(); renderDeckList(); currentDeck = null; renderMainArea(); 
                alert("Nahr√°no!");
            } catch (err) { alert("Chyba souboru JSON: " + err.message); }
        };
        reader.readAsText(file);
    }

    function wipeAllData() {
        if(confirm("Smazat v≈°e?")) { localStorage.removeItem("teacher_decks_v1"); location.reload(); }
    }

    // --- QR & AI ---
    function openQrModal() { document.getElementById('qr-modal').style.display = 'flex'; document.getElementById('qr-result').classList.add('hidden'); }
    function generateQr() {
        const f = document.getElementById('qr-filename').value;
        if (!f) return alert("Zadejte n√°zev!");
        const url = `https://tondam77-faith.github.io/historie/?balicek=${f}`;
        document.getElementById('qr-link-text').innerText = url;
        document.getElementById('qr-image').src = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(url)}`;
        document.getElementById('qr-result').classList.remove('hidden');
    }
    function copyLink() { navigator.clipboard.writeText(document.getElementById('qr-link-text').innerText).then(()=>alert("Zkop√≠rov√°no!")); }
    
    function openAiModal() { document.getElementById('ai-modal').style.display='flex'; }
    function copyAiPrompt() { navigator.clipboard.writeText(document.getElementById('ai-prompt-text').innerText).then(()=>alert("Zkop√≠rov√°no!")); }
    function showLightbox(src) { document.getElementById('lightbox-img').src = src; document.getElementById('lightbox').style.display = 'flex'; }

    // INIT
    renderDeckList();
</script>
</body>
</html>