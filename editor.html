<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <title>Editor Dƒõjepis SRS v3.2</title>
    <style>
        :root { --primary: #1a3a5a; --accent: #e67e22; --bg: #f4f7f6; --text: #2c3e50; --danger: #e74c3c; --success: #27ae60; }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg); color: var(--text); margin: 0; height: 100vh; display: flex; flex-direction: column; }
        
        /* HEADER */
        header { background: white; padding: 15px 30px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #ddd; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        h1 { margin: 0; font-size: 1.2rem; color: var(--primary); display: flex; align-items: center; gap: 10px; }
        
        .top-btn-group { display: flex; gap: 10px; }
        button { cursor: pointer; padding: 8px 15px; border-radius: 6px; border: none; font-weight: bold; transition: 0.2s; font-size: 0.9rem; }
        
        .btn-main { background: var(--primary); color: white; } .btn-main:hover { background: #132c45; }
        .btn-sec { background: white; border: 1px solid #ccc; color: #555; } .btn-sec:hover { background: #f0f0f0; }
        .btn-qr { background: #fff8e1; border: 1px solid #ffe082; color: #f57f17; } .btn-qr:hover { background: #ffecb3; }
        .btn-ai { background: #e6f4ea; border: 1px solid #ceead6; color: #1e8e3e; } .btn-ai:hover { background: #dceid5; }
        
        /* LAYOUT */
        .workspace { display: flex; flex: 1; overflow: hidden; }
        .sidebar { width: 250px; background: white; border-right: 1px solid #ddd; display: flex; flex-direction: column; }
        .deck-list { flex: 1; overflow-y: auto; padding: 10px; }
        .deck-item { padding: 12px; margin-bottom: 5px; cursor: pointer; border-radius: 6px; display: flex; justify-content: space-between; background: #f9f9f9; }
        .deck-item:hover { background: #eef4f9; } .deck-item.active { background: var(--primary); color: white; }
        
        .main-area { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; }
        .deck-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; background: white; padding: 15px; border-radius: 8px; border: 1px solid #ddd; }
        
        table { width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.02); }
        th, td { padding: 10px 15px; text-align: left; border-bottom: 1px solid #eee; vertical-align: middle; }
        th { background: #f8f9fa; font-weight: 600; color: #666; font-size: 0.9rem; }
        .thumb { width: 40px; height: 40px; object-fit: cover; border-radius: 4px; border: 1px solid #ccc; cursor: zoom-in; }
        
        .action-cell { white-space: nowrap; text-align: right; }
        .icon-btn { background: none; border: none; font-size: 1.1rem; cursor: pointer; opacity: 0.6; padding: 5px; }
        .icon-btn:hover { opacity: 1; transform: scale(1.1); }

        /* MODAL */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; display: none; justify-content: center; align-items: center; }
        .modal { background: white; width: 600px; max-width: 95%; max-height: 90vh; border-radius: 12px; display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .modal-header { padding: 15px 20px; background: #f8f9fa; border-bottom: 1px solid #eee; font-weight: bold; display: flex; justify-content: space-between; align-items: center;}
        .modal-body { padding: 20px; overflow-y: auto; }
        .modal-footer { padding: 15px 20px; border-top: 1px solid #eee; text-align: right; background: #f8f9fa; }
        
        .form-group { margin-bottom: 15px; }
        label { display: block; font-size: 0.85rem; font-weight: bold; margin-bottom: 5px; color: #555; }
        input[type="text"], textarea { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px; font-family: inherit; box-sizing: border-box; }
        textarea { min-height: 80px; resize: vertical; }
        
        .img-drop-zone { border: 2px dashed #ccc; padding: 10px; text-align: center; border-radius: 6px; margin-top: 5px; background: #fafafa; display: flex; align-items: center; justify-content: center; gap: 10px; min-height: 50px; }
        .preview-large { max-height: 100px; max-width: 100%; display: block; border: 1px solid #ddd; }
        .hidden { display: none; }

        .link-box { background: #e3f2fd; padding: 10px; border: 1px solid #90caf9; color: #1565c0; font-family: monospace; word-break: break-all; margin-top:10px; cursor: pointer; text-align: center;}
        .ai-box { background: #f4f7f6; padding: 15px; border-radius: 8px; border: 1px solid #ddd; font-family: monospace; font-size: 0.85rem; white-space: pre-wrap; margin-bottom: 15px; color: #333; }
        
        .lightbox-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 2000; display: none; justify-content: center; align-items: center; cursor: zoom-out; }
        .lightbox-img { max-width: 90%; max-height: 90%; border-radius: 4px; box-shadow: 0 0 20px rgba(0,0,0,0.5); }
    </style>
</head>
<body>

<header>
    <h1>üéì Editor v3.2 <span style="font-size:0.8rem; font-weight:normal; opacity:0.7;">(Auto-ID Fix)</span></h1>
    <div class="top-btn-group">
        <button class="btn-qr" onclick="openQrModal()">üîó Generovat odkaz</button>
        <button class="btn-ai" onclick="openAiModal()">ü§ñ AI Prompt</button>
        <button class="btn-sec" onclick="document.getElementById('file-in').click()">üìÇ Nahr√°t JSON</button>
        <button class="btn-main" onclick="exportData()">üíæ Ulo≈æit pro ≈æ√°ky</button>
    </div>
    <input type="file" id="file-in" accept=".json" style="display:none" onchange="importData(event)">
</header>

<div class="workspace">
    <div class="sidebar">
        <div class="deck-list" id="deck-list"></div>
        <div style="padding:15px; border-top:1px solid #eee;">
            <button class="btn-main" style="width:100%" onclick="addNewDeck()">‚ûï Nov√© t√©ma</button>
            <button class="btn-sec" style="width:100%; margin-top:10px; color:var(--danger); border-color:var(--danger);" onclick="wipeAllData()">üóëÔ∏è Vymazat v≈°e</button>
        </div>
    </div>

    <div class="main-area" id="main-area">
        <div style="text-align:center; color:#999; margin-top:50px;">Vyberte t√©ma vlevo nebo vytvo≈ôte nov√©.</div>
    </div>
</div>

<div class="modal-overlay" id="modal-overlay">
    <div class="modal">
        <div class="modal-header"><span>Karta</span><button onclick="closeModal()" style="border:none; background:none; font-size:1.2rem; cursor:pointer;">‚úñ</button></div>
        <div class="modal-body">
            <input type="hidden" id="edit-id">
            
            <div class="form-group">
                <label>Ot√°zka</label>
                <input type="text" id="edit-q">
                <div class="img-drop-zone">
                    <label class="btn-sec" style="font-size:0.8rem; padding:4px 8px;">üì∑ Foto<input type="file" hidden accept="image/*" onchange="processFile(this.files[0], 'q')"></label>
                    <img id="prev-q" class="preview-large hidden">
                    <button class="btn-sec hidden" id="del-q" onclick="removeImg('q')" style="color:red;">X</button>
                </div>
            </div>

            <div class="form-group">
                <label>Odpovƒõƒè (ka≈æd√Ω ≈ô√°dek = jedna odr√°≈æka)</label>
                <textarea id="edit-a"></textarea>
                <div class="img-drop-zone">
                    <label class="btn-sec" style="font-size:0.8rem; padding:4px 8px;">üì∑ Foto<input type="file" hidden accept="image/*" onchange="processFile(this.files[0], 'a')"></label>
                    <img id="prev-a" class="preview-large hidden">
                    <button class="btn-sec hidden" id="del-a" onclick="removeImg('a')" style="color:red;">X</button>
                </div>
            </div>
            
            <div class="form-group">
                <label style="display:flex; align-items:center; cursor:pointer;">
                    <input type="checkbox" id="edit-expert" style="width:20px; height:20px; margin-right:10px;">
                    üéì Roz≈°i≈ôuj√≠c√≠ uƒçivo (Expert)
                </label>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn-sec" onclick="closeModal()">Zru≈°it</button>
            <button class="btn-main" onclick="saveCard()">Ulo≈æit</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="qr-modal">
    <div class="modal" style="width:500px;">
        <div class="modal-header"><span>üîó Gener√°tor odkazu</span><button onclick="document.getElementById('qr-modal').style.display='none'" style="border:none; background:none; cursor:pointer;">‚úñ</button></div>
        <div class="modal-body">
            <p>1. Nahrajte ulo≈æen√Ω JSON soubor na GitHub.</p>
            <p>2. Zadejte p≈ôesn√Ω n√°zev souboru (nap≈ô. <code>velka_morava.json</code>):</p>
            <input type="text" id="qr-filename" placeholder="nazev_souboru.json">
            <div id="qr-result" class="hidden" style="margin-top:20px; text-align:center;">
                <label>Odkaz pro ≈æ√°ky:</label>
                <div class="link-box" id="qr-link-text" onclick="copyLink()"></div>
                <div style="margin-top:15px;"><img id="qr-image" style="max-width:200px; border:1px solid #ccc;"></div>
            </div>
        </div>
        <div class="modal-footer"><button class="btn-main" onclick="generateQr()">Generovat</button></div>
    </div>
</div>

<div class="modal-overlay" id="ai-modal">
    <div class="modal">
        <div class="modal-header"><span>ü§ñ AI Prompt</span><button onclick="document.getElementById('ai-modal').style.display='none'" style="border:none; background:none; cursor:pointer;">‚úñ</button></div>
        <div class="modal-body">
            <div class="ai-box" id="ai-prompt-text">Vytvo≈ô mi sadu 10 ot√°zek na t√©ma [T√âMA].
V√Ωstup mus√≠ b√Ωt ƒçist√Ω JSON v tomto form√°tu:
{
  "N√°zev T√©matu": [
    {
      "q": "Ot√°zka?",
      "a": ["Odpovƒõƒè 1"],
      "expert": false,
      "id": 1718892345678
    }
  ]
}
Pokud m≈Ø≈æe≈°, vygeneruj unik√°tn√≠ ID (timestamp) ke ka≈æd√© kartƒõ.</div>
        </div>
        <div class="modal-footer"><button class="btn-main" onclick="copyAiPrompt()">Kop√≠rovat do schr√°nky</button></div>
    </div>
</div>

<div class="lightbox-overlay" id="lightbox" onclick="this.style.display='none'">
    <img id="lightbox-img" class="lightbox-img">
</div>

<script>
    let decks = JSON.parse(localStorage.getItem("teacher_decks_v3")) || {};
    let currentDeck = null;
    let editingCardId = null; 
    let tempImgQ = "", tempImgA = "";

    // --- UI FUNKCE ---
    function renderDeckList() {
        const list = document.getElementById('deck-list');
        list.innerHTML = "";
        Object.keys(decks).forEach(name => {
            const div = document.createElement('div');
            div.className = `deck-item ${currentDeck === name ? 'active' : ''}`;
            div.innerHTML = `<span>${name}</span> <small>(${decks[name].length})</small>`;
            div.onclick = () => { currentDeck = name; renderDeckList(); renderMainArea(); };
            list.appendChild(div);
        });
    }

    function renderMainArea() {
        if (!currentDeck) return;
        const area = document.getElementById('main-area');
        let html = `
            <div class="deck-header">
                <h2 style="margin:0;">${currentDeck}</h2>
                <div>
                    <button class="btn-main" onclick="openModal()">‚ûï P≈ôidat kartu</button>
                    <button class="btn-sec" style="color:red;" onclick="deleteDeck()">üóëÔ∏è Smazat sadu</button>
                </div>
            </div>
            <table><thead><tr>
                <th style="width:50px">Obr</th>
                <th>Ot√°zka</th>
                <th>Odpovƒõƒè</th>
                <th style="width:50px">Obr</th>
                <th style="width:140px; text-align:right;">Akce</th>
            </tr></thead><tbody>
        `;
        
        decks[currentDeck].forEach((c, i) => {
            const qImg = c.qImg ? `<img src="${c.qImg}" class="thumb" onclick="showLightbox('${c.qImg}')">` : '-';
            const aImg = c.aImg ? `<img src="${c.aImg}" class="thumb" onclick="showLightbox('${c.aImg}')">` : '-';
            const expert = c.expert ? 'üéì ' : '';
            
            html += `<tr>
                <td>${qImg}</td>
                <td>${expert} ${c.q}</td>
                <td>${Array.isArray(c.a) ? c.a.join(', ') : c.a}</td>
                <td>${aImg}</td>
                <td class="action-cell">
                    <button class="icon-btn" onclick="moveCard(${i}, -1)" title="Nahoru">‚¨ÜÔ∏è</button>
                    <button class="icon-btn" onclick="moveCard(${i}, 1)" title="Dol≈Ø">‚¨áÔ∏è</button>
                    <button class="icon-btn" onclick="duplicateCard(${i})" title="Duplikovat">üìã</button>
                    <button class="icon-btn" onclick="openModal(${i})" title="Upravit">‚úèÔ∏è</button>
                    <button class="icon-btn" style="color:red" onclick="removeCard(${i})" title="Smazat">üóëÔ∏è</button>
                </td>
            </tr>`;
        });
        area.innerHTML = html + "</tbody></table>";
    }

    // --- IMPORT S AUTOMATICK√ùM DOPLNƒöN√çM ID ---
    function importData(e) {
        const file = e.target.files[0]; if(!file) return;
        const reader = new FileReader();
        reader.onload = (v) => {
            try {
                let txt = v.target.result;
                if (txt.charCodeAt(0) === 0xFEFF) txt = txt.slice(1); // Edge Fix
                
                const loadedData = JSON.parse(txt);
                
                // AUTO-FIX: Doplnƒõn√≠ chybƒõj√≠c√≠ch ID
                for (const deckName in loadedData) {
                    loadedData[deckName].forEach((card, index) => {
                        if (!card.id) {
                            // Vygenerujeme ID pokud chyb√≠ (timestamp + random suffix pro jistotu)
                            card.id = Date.now() + Math.floor(Math.random() * 100000) + index;
                        }
                        // Dopln√≠me defaultn√≠ SRS data, pokud chyb√≠
                        if (typeof card.reps === 'undefined') {
                            card.reps = 0; card.interval = 0; card.ef = 2.5; card.nextReview = Date.now();
                        }
                    });
                }

                decks = Object.assign(decks, loadedData);
                saveToStorage(); 
                renderDeckList(); 
                currentDeck = null; 
                renderMainArea(); 
                alert("Nahr√°no! ID byla automaticky doplnƒõna.");
            } catch(e) { alert("Chyba JSON: " + e.message); }
        };
        reader.readAsText(file);
    }

    // --- OSTATN√ç FUNKCE ---
    function openModal(index = null) {
        document.getElementById('modal-overlay').style.display = 'flex';
        tempImgQ = ""; tempImgA = "";
        
        if (index !== null) {
            editingCardId = index;
            const c = decks[currentDeck][index];
            document.getElementById('edit-q').value = c.q;
            document.getElementById('edit-a').value = Array.isArray(c.a) ? c.a.join('\n') : c.a;
            document.getElementById('edit-expert').checked = c.expert || false;
            tempImgQ = c.qImg || "";
            tempImgA = c.aImg || "";
        } else {
            editingCardId = null;
            document.getElementById('edit-q').value = "";
            document.getElementById('edit-a').value = "";
            document.getElementById('edit-expert').checked = false;
        }
        updatePreview('q'); updatePreview('a');
    }

    function closeModal() { document.getElementById('modal-overlay').style.display = 'none'; }

    function saveCard() {
        const q = document.getElementById('edit-q').value.trim();
        const aVal = document.getElementById('edit-a').value.trim();
        const isExpert = document.getElementById('edit-expert').checked;

        if (!q || !aVal) { alert("Vypl≈àte ot√°zku a odpovƒõƒè."); return; }

        const newCard = {
            id: Date.now(), // Unik√°tn√≠ ID
            q: q,
            a: aVal.split('\n'),
            qImg: tempImgQ,
            aImg: tempImgA,
            expert: isExpert,
            reps: 0, interval: 0, ef: 2.5, nextReview: Date.now()
        };

        if (editingCardId !== null) {
            const old = decks[currentDeck][editingCardId];
            newCard.id = old.id || Date.now();
            newCard.reps = old.reps || 0;
            newCard.interval = old.interval || 0;
            newCard.ef = old.ef || 2.5;
            newCard.nextReview = old.nextReview || Date.now();
            decks[currentDeck][editingCardId] = newCard;
        } else {
            decks[currentDeck].push(newCard);
        }

        saveToStorage();
        closeModal();
        renderMainArea();
        renderDeckList();
    }

    function moveCard(index, direction) {
        const newIndex = index + direction;
        if (newIndex >= 0 && newIndex < decks[currentDeck].length) {
            const temp = decks[currentDeck][index];
            decks[currentDeck][index] = decks[currentDeck][newIndex];
            decks[currentDeck][newIndex] = temp;
            saveToStorage(); renderMainArea();
        }
    }

    function duplicateCard(index) {
        const source = decks[currentDeck][index];
        const copy = JSON.parse(JSON.stringify(source));
        copy.id = Date.now(); 
        copy.q += " (kopie)";
        decks[currentDeck].splice(index + 1, 0, copy);
        saveToStorage(); renderMainArea(); renderDeckList();
    }

    function removeCard(index) {
        if(confirm("Smazat?")) { decks[currentDeck].splice(index, 1); saveToStorage(); renderMainArea(); renderDeckList(); }
    }

    function processFile(file, type) {
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            if (type === 'q') tempImgQ = e.target.result; else tempImgA = e.target.result;
            updatePreview(type);
        };
        reader.readAsDataURL(file);
    }
    function updatePreview(type) {
        const url = (type === 'q') ? tempImgQ : tempImgA;
        const img = document.getElementById(`prev-${type}`);
        const btn = document.getElementById(`del-${type}`);
        if (url) { img.src = url; img.classList.remove('hidden'); btn.classList.remove('hidden'); }
        else { img.classList.add('hidden'); btn.classList.add('hidden'); }
    }
    function removeImg(type) { if (type === 'q') tempImgQ = ""; else tempImgA = ""; updatePreview(type); }
    function showLightbox(src) { document.getElementById('lightbox-img').src = src; document.getElementById('lightbox').style.display = 'flex'; }

    function addNewDeck() { const n = prompt("N√°zev sady:"); if(n) { decks[n] = []; currentDeck = n; saveToStorage(); renderDeckList(); renderMainArea(); } }
    function deleteDeck() { if(confirm("Smazat celou sadu?")) { delete decks[currentDeck]; currentDeck = null; saveToStorage(); renderDeckList(); document.getElementById('main-area').innerHTML = ""; } }
    function saveToStorage() { localStorage.setItem("teacher_decks_v3", JSON.stringify(decks)); }
    function wipeAllData() { if(confirm("Opravdu smazat V≈†E?")) { localStorage.removeItem("teacher_decks_v3"); location.reload(); } }

    function exportData() {
        const blob = new Blob([JSON.stringify(decks, null, 2)], {type: "application/json"});
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = "historie_srs.json"; a.click();
    }

    // QR & AI
    function openQrModal() { document.getElementById('qr-modal').style.display='flex'; document.getElementById('qr-result').classList.add('hidden'); }
    function generateQr() {
        const f = document.getElementById('qr-filename').value; if(!f) return alert("Zadejte n√°zev!");
        const url = `https://tondam77-faith.github.io/historie/?balicek=${f}`;
        document.getElementById('qr-link-text').innerText = url;
        document.getElementById('qr-image').src = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(url)}`;
        document.getElementById('qr-result').classList.remove('hidden');
    }
    function copyLink() { navigator.clipboard.writeText(document.getElementById('qr-link-text').innerText).then(()=>alert("Zkop√≠rov√°no!")); }
    
    function openAiModal() { document.getElementById('ai-modal').style.display='flex'; }
    function copyAiPrompt() { navigator.clipboard.writeText(document.getElementById('ai-prompt-text').innerText).then(()=>alert("Zkop√≠rov√°no!")); }

    renderDeckList();
</script>
</body>
</html>