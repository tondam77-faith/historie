<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <title>Uƒçitelsk√Ω Editor - Dƒõjepis SRS v1.5 (Fixed)</title>
    <style>
        :root { --primary: #1a3a5a; --accent: #e67e22; --bg: #f4f7f6; --text: #2c3e50; --danger: #e74c3c; }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg); color: var(--text); margin: 0; height: 100vh; display: flex; flex-direction: column; }
        header { background: white; padding: 15px 30px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #ddd; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        h1 { margin: 0; font-size: 1.2rem; color: var(--primary); display: flex; align-items: center; gap: 10px; }
        .top-btn-group { display: flex; gap: 10px; }
        button { cursor: pointer; padding: 8px 15px; border-radius: 6px; border: none; font-weight: bold; transition: 0.2s; }
        .btn-main { background: var(--primary); color: white; } .btn-main:hover { background: #132c45; }
        .btn-sec { background: white; border: 1px solid #ccc; color: #555; } .btn-sec:hover { background: #f0f0f0; }
        .btn-danger { background: #fff; border: 1px solid var(--danger); color: var(--danger); } .btn-danger:hover { background: var(--danger); color: white; }
        .btn-ai { background: #e6f4ea; border: 1px solid #ceead6; color: #1e8e3e; } .btn-ai:hover { background: #dceid5; }
        .btn-qr { background: #fff8e1; border: 1px solid #ffe082; color: #f57f17; } .btn-qr:hover { background: #ffecb3; }
        
        .workspace { display: flex; flex: 1; overflow: hidden; }
        .sidebar { width: 250px; background: white; border-right: 1px solid #ddd; display: flex; flex-direction: column; }
        .deck-list { flex: 1; overflow-y: auto; padding: 10px; }
        .deck-item { padding: 12px; margin-bottom: 5px; cursor: pointer; border-radius: 6px; display: flex; justify-content: space-between; }
        .deck-item:hover { background: #f0f5f9; } .deck-item.active { background: var(--primary); color: white; }
        .main-area { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; }
        .deck-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; background: white; padding: 15px; border-radius: 8px; border: 1px solid #ddd; }
        
        table { width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.02); }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #eee; vertical-align: middle; }
        th { background: #f8f9fa; font-weight: 600; color: #666; font-size: 0.9rem; }
        
        /* MODAL */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; display: none; justify-content: center; align-items: center; }
        .modal { background: white; width: 600px; max-width: 90%; border-radius: 12px; display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .modal-header { padding: 15px 20px; background: #f8f9fa; border-bottom: 1px solid #eee; font-weight: bold; display: flex; justify-content: space-between; }
        .modal-body { padding: 20px; }
        .modal-footer { padding: 15px 20px; border-top: 1px solid #eee; text-align: right; background: #f8f9fa; }
        
        .form-group { margin-bottom: 15px; }
        label { display: block; font-size: 0.85rem; font-weight: bold; margin-bottom: 5px; color: #555; }
        input[type="text"], textarea { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px; font-family: inherit; }
        textarea { min-height: 80px; }
        
        .link-box { background: #e3f2fd; padding: 10px; border: 1px solid #90caf9; color: #1565c0; font-family: monospace; word-break: break-all; margin-top:10px; cursor: pointer; }
        .hidden { display: none; }
        .ai-box { background: #f4f7f6; padding: 15px; border-radius: 8px; border: 1px solid #ddd; font-family: monospace; font-size: 0.85rem; white-space: pre-wrap; margin-bottom: 15px; color: #333; }
    </style>
</head>
<body>

<header>
    <h1>üéì Uƒçitelsk√Ω Editor <span style="font-size:0.8rem; opacity:0.6; font-weight:normal;">v1.5+</span></h1>
    <div class="top-btn-group">
        <button class="btn-qr" onclick="openQrModal()" title="Vytvo≈ôit odkaz pro ≈æ√°ky">üîó Generovat odkaz</button>
        <button class="btn-ai" onclick="openAiModal()" title="Generovat ot√°zky pomoc√≠ AI">ü§ñ AI Prompt</button>
        <button class="btn-sec" onclick="document.getElementById('file-in').click()" title="Nahr√°t soubor z poƒç√≠taƒçe">üìÇ Nahr√°t JSON</button>
        <button class="btn-main" onclick="exportData()" title="St√°hnout soubor pro ≈æ√°ky">üíæ Ulo≈æit JSON</button>
    </div>
    <input type="file" id="file-in" accept=".json" style="display:none" onchange="importData(event)">
</header>

<div class="workspace">
    <div class="sidebar">
        <div class="deck-list" id="deck-list"></div>
        <div style="padding:15px; border-top:1px solid #eee;">
            <button class="btn-main" style="width:100%" onclick="addNewDeck()">‚ûï Nov√© t√©ma</button>
            <button class="btn-danger" style="width:100%; margin-top:10px;" onclick="wipeAllData()">üóëÔ∏è Reset</button>
        </div>
    </div>

    <div class="main-area" id="main-area">
        <div style="text-align:center; color:#999; margin-top:50px;">Vyberte t√©ma vlevo.</div>
    </div>
</div>

<div class="modal-overlay" id="modal-overlay">
    <div class="modal">
        <div class="modal-header"><span>Editace karty</span><button onclick="closeModal('modal-overlay')">‚úñ</button></div>
        <div class="modal-body">
            <input type="hidden" id="edit-id">
            <div class="form-group"><label>Ot√°zka</label><input type="text" id="edit-q"></div>
            <div class="form-group"><label>Odpovƒõƒè (≈ô√°dky)</label><textarea id="edit-a"></textarea></div>
        </div>
        <div class="modal-footer">
            <button class="btn-sec" onclick="closeModal('modal-overlay')">Zru≈°it</button>
            <button class="btn-main" onclick="saveCard()">Ulo≈æit</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="qr-modal">
    <div class="modal" style="width:500px;">
        <div class="modal-header"><span>üîó Gener√°tor odkazu</span><button onclick="closeModal('qr-modal')">‚úñ</button></div>
        <div class="modal-body">
            <p>Zadejte n√°zev souboru, kter√Ω jste nahr√°li na GitHub:</p>
            <input type="text" id="qr-filename" placeholder="nap≈ô. velka_morava.json">
            <div id="qr-result" class="hidden" style="margin-top:20px; text-align:center;">
                <label>Odkaz pro ≈æ√°ky:</label>
                <div class="link-box" id="qr-link-text" onclick="copyLink()"></div>
                <div style="margin-top:15px;"><img id="qr-image" style="max-width:200px; border:1px solid #ccc;"></div>
            </div>
        </div>
        <div class="modal-footer"><button class="btn-main" onclick="generateQr()">Generovat</button></div>
    </div>
</div>

<div class="modal-overlay" id="ai-modal">
    <div class="modal">
        <div class="modal-header"><span>ü§ñ AI Prompt</span><button onclick="closeModal('ai-modal')">‚úñ</button></div>
        <div class="modal-body">
            <div class="ai-box" id="ai-prompt-text">Vytvo≈ô mi sadu 10 ot√°zek na t√©ma [T√âMA].
V√Ωstup mus√≠ b√Ωt ƒçist√Ω JSON v tomto form√°tu:
{
  "N√°zev T√©matu": [
    {
      "q": "Ot√°zka?",
      "a": ["Odpovƒõƒè 1"]
    }
  ]
}
P≈ôidej ID ke ka≈æd√© kartƒõ (unik√°tn√≠ ƒç√≠slo).</div>
        </div>
        <div class="modal-footer"><button class="btn-main" onclick="copyAiPrompt()">Kop√≠rovat</button></div>
    </div>
</div>

<script>
    let decks = JSON.parse(localStorage.getItem("teacher_decks_v1")) || {};
    let currentDeck = null, editingCardId = null;

    function renderDeckList() {
        const list = document.getElementById('deck-list'); list.innerHTML = "";
        Object.keys(decks).forEach(name => {
            const div = document.createElement('div');
            div.className = `deck-item ${currentDeck===name?'active':''}`;
            div.innerText = `${name} (${decks[name].length})`;
            div.onclick = () => { currentDeck=name; renderDeckList(); renderMainArea(); };
            list.appendChild(div);
        });
    }

    function renderMainArea() {
        if (!currentDeck) return;
        let html = `<div class="deck-header"><h2>${currentDeck}</h2><button class="btn-main" onclick="openModal()">‚ûï P≈ôidat kartu</button></div><table>`;
        decks[currentDeck].forEach((c, i) => {
            html += `<tr><td>${c.q}</td><td>${Array.isArray(c.a)?c.a.join(', '):c.a}</td>
            <td style="text-align:right;"><button onclick="openModal(${i})">‚úèÔ∏è</button> <button style="color:red" onclick="delCard(${i})">üóëÔ∏è</button></td></tr>`;
        });
        document.getElementById('main-area').innerHTML = html + "</table>";
    }

    function openModal(idx=null) {
        document.getElementById('modal-overlay').style.display='flex';
        if(idx!==null) {
            const c = decks[currentDeck][idx]; editingCardId=idx;
            document.getElementById('edit-q').value=c.q; document.getElementById('edit-a').value=Array.isArray(c.a)?c.a.join('\n'):c.a;
        } else {
            editingCardId=null; document.getElementById('edit-q').value=""; document.getElementById('edit-a').value="";
        }
    }
    function closeModal(id) { document.getElementById(id).style.display='none'; }
    
    // --- OPRAVEN√Å FUNKCE ULO≈ΩEN√ç KARTY ---
    function saveCard() {
        const q=document.getElementById('edit-q').value, a=document.getElementById('edit-a').value;
        if(!q||!a) return;
        
        // Zde vytv√°≈ô√≠me kompletn√≠ objekt karty s ID a SRS daty
        const newCard = {
            q: q, 
            a: a.split('\n'), 
            id: Date.now(),       // UNIK√ÅTN√ç ID (ƒçasov√© raz√≠tko)
            reps: 0,              // Poƒçet opakov√°n√≠ (start = 0)
            interval: 0,          // Interval (start = 0)
            ef: 2.5,              // Easy Factor (start = 2.5)
            nextReview: Date.now() // Kdy zkou≈°et (ihned)
        };
        
        if(editingCardId!==null) {
            // P≈ôi editaci zachov√°me ID a pokrok, pokud existuj√≠
            const oldCard = decks[currentDeck][editingCardId];
            newCard.id = oldCard.id || Date.now();
            newCard.reps = oldCard.reps || 0;
            newCard.interval = oldCard.interval || 0;
            newCard.ef = oldCard.ef || 2.5;
            newCard.nextReview = oldCard.nextReview || Date.now();
            
            decks[currentDeck][editingCardId] = newCard; 
        } else {
            decks[currentDeck].push(newCard);
        }
        
        localStorage.setItem("teacher_decks_v1", JSON.stringify(decks));
        closeModal('modal-overlay'); renderMainArea(); renderDeckList();
    }

    function delCard(i) { decks[currentDeck].splice(i,1); localStorage.setItem("teacher_decks_v1", JSON.stringify(decks)); renderMainArea(); renderDeckList(); }
    function addNewDeck() { const n=prompt("N√°zev:"); if(n) { decks[n]=[]; renderDeckList(); } }
    function wipeAllData() { if(confirm("Smazat v≈°e?")) { localStorage.removeItem("teacher_decks_v1"); location.reload(); } }
    
    function exportData() { 
        // Form√°tov√°n√≠ JSONu pro lep≈°√≠ ƒçitelnost
        const b = new Blob([JSON.stringify(decks,null,2)], {type:"application/json"}); 
        const a=document.createElement('a'); a.href=URL.createObjectURL(b); a.download="historie_srs.json"; a.click(); 
    }
    
    function importData(e) { 
        const r=new FileReader(); 
        r.onload=v=>{ 
            try {
                // Fix pro Edge (BOM)
                let content = v.target.result;
                if (content.charCodeAt(0) === 0xFEFF) { content = content.slice(1); }
                
                decks=Object.assign(decks, JSON.parse(content)); 
                localStorage.setItem("teacher_decks_v1", JSON.stringify(decks)); 
                renderDeckList(); 
                alert("Nahr√°no!");
            } catch(e) { alert("Chyba JSON souboru!"); }
        }; 
        r.readAsText(e.target.files[0]); 
    }

    // QR LOGIC
    function openQrModal() { document.getElementById('qr-modal').style.display='flex'; document.getElementById('qr-result').classList.add('hidden'); }
    function generateQr() {
        const f = document.getElementById('qr-filename').value; if(!f) return alert("Zadejte n√°zev!");
        const url = `https://tondam77-faith.github.io/historie/?balicek=${f}`;
        document.getElementById('qr-link-text').innerText = url;
        document.getElementById('qr-image').src = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(url)}`;
        document.getElementById('qr-result').classList.remove('hidden');
    }
    function copyLink() { navigator.clipboard.writeText(document.getElementById('qr-link-text').innerText).then(()=>alert("Zkop√≠rov√°no!")); }
    
    function openAiModal() { document.getElementById('ai-modal').style.display='flex'; }
    function copyAiPrompt() { navigator.clipboard.writeText(document.getElementById('ai-prompt-text').innerText).then(()=>alert("Zkop√≠rov√°no!")); }

    renderDeckList();
</script>
</body>
</html>